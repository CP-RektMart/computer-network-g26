<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Socket.IO Client</title>
  <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
  <style>
    body {
      display: flex;
      justify-content: space-between;
      padding: 20px;
    }
    #leftSection {
      width: 45%;
    }
    #rightSection {
      width: 45%;
    }
    #exampleTokens {
      margin-top: 20px;
    }
    .exampleToken {
      margin: 10px 0;
      padding: 10px;
      background-color: #f0f0f0;
      border: 1px solid #ccc;
      cursor: pointer;
    }
    #messages {
    height: 300px; 
    overflow-y: auto;
    border: 1px solid #ccc; 
  }
  </style>
</head>
<body>
  <div id="leftSection">
    <h1>Socket.IO Client</h1>

    <!-- JWT Token Input -->
    <div>
      <textarea id="jwtTokenInput" placeholder="Enter your JWT token" style="width: 100%; height: 100px; font-size: 16px;"></textarea>
    </div>
    
    <!-- Connection Type Selection -->
    <div>
      <label for="connectionType">Connection Type:</label>
      <select id="connectionType" onchange="toggleConnectionInputs()">
        <option value="group">Group</option>
        <option value="direct">Direct</option>
      </select>
    </div>

    <!-- Group or Receiver ID Inputs -->
    <div id="groupIdSection">
      <label for="groupIdInput">Group ID:</label>
      <input type="text" id="groupIdInput" placeholder="Enter group ID" />
    </div>
    <div id="receiverIdSection" style="display: none;">
      <label for="receiverIdInput">Receiver ID:</label>
      <input type="text" id="receiverIdInput" placeholder="Enter receiver ID" />
    </div>

    <button onclick="connectToServer()">Connect</button>

    <!-- Show Connection Data -->
    <div id="connectionDataSection">
      <strong>Connection Info:</strong>
      <div id="connectionStatus">Not connected</div>
      <div id="connectionDetails" style="display: none;">
        <div><strong>UserId: </strong><span id="userIdDisplay">None</span></div> 
        <div><strong>Name: </strong><span id="nameDisplay">None</span></div> 
        <div><strong>Type: </strong><span id="connectionTypeDisplay">None</span></div>
        <div id="groupIdDisplaySection"><strong>Group ID: </strong><span id="groupIdDisplay">None</span></div>
        <div id="receiverIdDisplaySection"><strong>Receiver ID: </strong><span id="receiverIdDisplay">None</span></div>
      </div>
    </div>

    <!-- Messages Section -->
    <div id="messages"></div>

    <!-- Message Input -->
    <input type="text" id="messageInput" placeholder="Type a message" oninput="toggleInputType()" /> 
    <button onclick="sendMessage()">Send</button>
  </div>

  <div id="rightSection">
    <h2>Example JWT Tokens (JWT_SECRET = SECRET)</h2>
    <div id="exampleTokens">
      <div class="exampleToken" onclick="setJwtToken('exampleToken1')">UserId: 1: Joined Group 1</div>
      <div class="exampleToken" onclick="setJwtToken('exampleToken2')">UserId: 2: Joined Group 1</div>
      <div class="exampleToken" onclick="setJwtToken('exampleToken3')">UserId: 3: Joined Group 1, 2</div>
      <div class="exampleToken" onclick="setJwtToken('exampleToken4')">UserId: 4: Joined Group 2</div>
      <div class="exampleToken" onclick="setJwtToken('exampleToken5')">UserId: 5: Joined Group 2</div>
    </div>
  </div>

  <script>
    let socket; 
    let lastMessageId = null; 
    let lastSendAt = null;
    const pageSize = 20;
    let isFetching = false;
    let hasMoreMessages = true;
    let previousScrollTop = 0;

    // Function to connect to the server with the JWT token
    async function connectToServer() {
      const jwtToken = document.getElementById('jwtTokenInput').value;
      const connectionType = document.getElementById('connectionType').value;
      const groupId = document.getElementById('groupIdInput').value;
      const receiverId = document.getElementById('receiverIdInput').value;

      if (!jwtToken) {
        alert("Please enter a JWT token to connect.");
        return;
      }

      // Validate groupId or receiverId based on connection type
      if (connectionType === 'group' && !groupId) {
        alert("Please enter a Group ID for the group connection.");
        return;
      }
      if (connectionType === 'direct' && !receiverId) {
        alert("Please enter a Receiver ID for the direct connection.");
        return;
      }

      // If a socket connection already exists, disconnect it
      if (socket && socket.connected) {
        socket.disconnect();
        console.log('Old socket connection closed.');
      }

      // Clear previous messages before establishing a new connection
      const messagesDiv = document.getElementById('messages');
      messagesDiv.innerHTML = '';

      // Connect to the Socket.IO server with JWT token and connection-specific data
      socket = io('http://localhost:3000', {
        auth: {
          token: jwtToken, 
          type: connectionType,
          groupId: connectionType === 'group' ? groupId : undefined, 
          receiverId: connectionType === 'direct' ? receiverId : undefined, 
        },
      });

      socket.on('socket-messages', (message) => {
        console.log("Received data", message)
        const messagesDiv = document.getElementById('messages');
        const msgBox = messageBox(message);
        messagesDiv.appendChild(msgBox);
        messagesDiv.scrollTop = messagesDiv.scrollHeight; 
      });

      // Log the connection status
      socket.on('connect', async () => {
        console.log('Connected to server with socket ID:', socket.id);

        document.getElementById('connectionStatus').textContent = 'Connected';
        document.getElementById('connectionDetails').style.display = 'block';
      });

      // Connection Error
      socket.on('connect_error', (err) => {
        console.error('Connection error:', err.message);
      });

      // Disconnect Reason
      socket.on('disconnectReason', (reason) => {
        console.warn('Disconnected from server. Reason:', reason);

        document.getElementById('connectionStatus').textContent = 'Disconnected';
        document.getElementById('connectionDetails').style.display = 'none';
      });

      // Connected the connection
      socket.on('connected', async (data) => {
        console.log('Connected with data:', data);

        // Update connection info on the page
        document.getElementById('connectionTypeDisplay').textContent = data.type || 'None';
        document.getElementById('nameDisplay').textContent = data.username || 'None';  
        document.getElementById('userIdDisplay').textContent = data.userId || 'None';  

        // Show or hide Group ID section
        if (data.groupId) {
          document.getElementById('groupIdDisplay').textContent = data.groupId + " " + data.groupName;
          document.getElementById('groupIdDisplaySection').style.display = 'block'; // Show
        } else {
          document.getElementById('groupIdDisplaySection').style.display = 'none'; // Hide
        }

        // Show or hide Receiver ID section
        if (data.receiverId) {
          document.getElementById('receiverIdDisplay').textContent = data.receiverId + " " + data.receiverName;
          document.getElementById('receiverIdDisplaySection').style.display = 'block'; // Show
        } else {
          document.getElementById('receiverIdDisplaySection').style.display = 'none'; // Hide
        }
        });

        const  messages = await fetchMessages(true) 

        messages.forEach((message) => {
          const msgBox = messageBox(message);
            messagesDiv.insertBefore(msgBox, messagesDiv.firstChild); 
          } 
        );

        hasMoreMessages = true;
        previousScrollTop = 0;
        isFetching = false;
        if (messages) {
          lastMessageId = messages[messages.length - 1].id;
          lastSendAt = messages[messages.length - 1].sentAt;
        }

        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Listen for incoming messages from the server

    // Function to toggle the visibility of the Group ID or Receiver ID input fields
    function toggleConnectionInputs() {
      const connectionType = document.getElementById('connectionType').value;

      if (connectionType === 'group') {
        document.getElementById('groupIdSection').style.display = 'block';
        document.getElementById('receiverIdSection').style.display = 'none';
      } else {
        document.getElementById('groupIdSection').style.display = 'none';
        document.getElementById('receiverIdSection').style.display = 'block';
      }
    }

        // Set JWT Token when clicking on example tokens
        function setJwtToken(exampleToken) {
      const tokenMap = {
        exampleToken1: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwiaWF0IjoxNTE2MjM5MDIyLCJ1c2VySWQiOjEsIm5hbWUiOiJKb2huIERvZSJ9.lajg-DFxWnOmUNW7Vy6OdHd42pSZihiUNgppuLrY8mc',
        exampleToken2: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwiaWF0IjoxNTE2MjM5MDIyLCJ1c2VySWQiOjIsIm5hbWUiOiJTaXJpd2lkIFRpbiJ9.5l0MuK4a3xNvBwSmxLucY_DtzngYShdCue0QOVnLraY',
        exampleToken3: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwiaWF0IjoxNTE2MjM5MDIyLCJ1c2VySWQiOjMsIm5hbWUiOiJFaWVpIEt1bmcifQ.vPZyQXHEI4sWwRJ2gjBai0us3q5-EBm24MagWzkj7Q4',
        exampleToken4: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwiaWF0IjoxNTE2MjM5MDIyLCJ1c2VySWQiOjQsIm5hbWUiOiJTcGFyayBEb29tIn0.11R88VVI41nc81aA6p1e95v7UJsyn7mOOKu2p1kLTDs',
        exampleToken5: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwiaWF0IjoxNTE2MjM5MDIyLCJ1c2VySWQiOjUsIm5hbWUiOiJNb25rZXkgS2luZyJ9.yihzb7LGvfKICFxcVx3JIBkFymYT9RXFVUsYKF1br5s',
      };

      document.getElementById('jwtTokenInput').value = tokenMap[exampleToken];
    }

    window.onload = toggleConnectionInputs;

    // Send message to server
    async function sendMessage() {
      const messageInput = document.getElementById('messageInput');
      const text = messageInput.value;
      
      if (text) {
        console.log("Sending text:", text);
        
        if (!text) {
          alert("Please enter a text.");
          return;
        }

        const messageData = {
          content: {
            type: "text",
            text: text
          },
          senderId: socket.id, 
        };
        
        // Emit the message to the server
        socket.emit('socket-messages', messageData);

        // Clear the input fields
        messageInput.value = '';
      } 
      else {
        alert("Please enter a message");
      }
    }

    // Checking for Scroll Top
    document.getElementById('messages').addEventListener('scroll', async function () {
      const messagesDiv = this;
      if (messagesDiv.scrollTop === 0 && !isFetching && hasMoreMessages) {

        const previousScrollHeight = messagesDiv.scrollHeight;

        const messages = await fetchMessages(false) 
        if (messages.length === 0) {
          return;
        }
        messages.forEach((message) => {
          const msgBox = messageBox(message);
          messagesDiv.insertBefore(msgBox, messagesDiv.firstChild); 
        });
        
          lastMessageId = messages[messages.length - 1].id;
          lastSendAt = messages[messages.length - 1].sentAt;

          messagesDiv.scrollTop = messagesDiv.scrollHeight - previousScrollHeight;
      }
    });

    // Create a Message Box
    function messageBox(message) {
        const newMessage = document.createElement('div');
        newMessage.style.display = 'flex';
        newMessage.style.alignItems = 'center';
        newMessage.style.marginBottom = '10px';  

        const username = document.createElement('span');
        username.style.fontWeight = 'bold';
        username.style.marginRight = '10px'; 
        username.textContent = `${message.user.username}:`;

        const messageContent = document.createElement('span');
        let contentText = '';

        if (message.content.type === 'text') {
            contentText = `${message.content.text}`;
        } else {
            contentText = 'invalid content!!';
        }

        messageContent.textContent = contentText;

        newMessage.appendChild(username);
        newMessage.appendChild(messageContent);

        return newMessage;
    }

    // Fetch Messages 
    async function fetchMessages(isInitialFetch = true) {
      try {
        const jwtToken = document.getElementById('jwtTokenInput').value;
        const groupId = document.getElementById('groupIdInput').value;
        if (!groupId) {
          return [];
        }

        const url = isInitialFetch
          ? `http://localhost:3000/api/groups/${groupId}/messages?limit=${pageSize}`
          : `http://localhost:3000/api/groups/${groupId}/messages?limit=${pageSize}&before=${lastSendAt}`;

        const res = await fetch(url, {
          headers: {
            'Authorization': `Bearer ${jwtToken}`,
          }
        });

        if (!res.ok) throw new Error(isInitialFetch ? 'Failed to fetch recent messages' : 'Failed to fetch more messages');

        const messages = await res.json();

        if (messages.length === 0 && !isInitialFetch) {
          hasMoreMessages = false;
          return [];
        }

        console.log(isInitialFetch ? "Fetched recently 20 messages:" : "Fetched older 20 messages:", messages);

        return messages;

      } catch (err) {
        console.error("Error fetching messages:", err);
        return [];
      } finally {
        isFetching = false;
      }
    }

  </script>
</body>
</html>
